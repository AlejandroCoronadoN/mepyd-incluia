from metrics.met0_createindex import (
      condense_admindiv,
      get_coverage_offer_indexes,
      get_percentages_demand_indexes,
)
from projectetl.utils.config import data_dir
import geopandas as gpd
import pandas as pd 
import numpy as np 
from projectetl.utils.dataload import load_s3_data_do, get_path_from_pattern

stats_processed_neighborhood = pd.read_csv(f'data/testData/process/metrics_neighborhoods_processed_test.csv')
stats_processed_municipality = pd.read_csv(f'data/testData/process/metrics_municipality_processed_test.csv')

def test_shape_end_rodrigo_neighborhood_integration():
    assert stats_processed_neighborhood.shape ==(12565, 139)
    
def test_describe_end_rodrigo_neighborhood_integration():
    df_describe =  stats_processed_neighborhood.describe()
    internal_dict = df_describe.loc['mean'].to_dict() 
    external_dict = {'caipi_sum_neighbor': 1.1470588235294117,
    'member_0to4_sum': 1122.6097560975609,
    'recibe_ciudados_inaipi_sum': 13.292682926829269,
    'recibe_ciudados_publico_no_inaipi_sum': 17.097560975609756,
    'recibe_ciudados_privado_sum': 9.585365853658537,
    'recibe_ciudados_otros_sum': 111.7560975609756,
    'superate_child_0to4_receiver_sum': 954.5853658536586,
    'member_5to12_sum': 1767.658536585366,
    'superate_child_5to12_receiver_sum': 1183.878048780488,
    'superate_disability_13to64_sum': 537.219512195122,
    'superate_disability_5to64_sum': 575.2926829268292,
    'superate_older_dependant_sum': 124.34146341463415,
    'superate_older_severe_dependant_sum': 65.6829268292683,
    'woman_domestic_worker_sum': 270.4878048780488,
    'woman_work_age_sum': 4255.1463414634145,
    'man_domestic_worker_sum': 9.829268292682928,
    'man_work_age_sum': 3728.317073170732,
    'member_id_count': 11299.073170731708,
    'superate_child_0to4_receiver_any': 799.9024390243902,
    'superate_child_5to12_receiver_any': 882.3414634146342,
    'superate_disability_13to64_any': 452.3658536585366,
    'superate_disability_5to64_any': 477.8780487804878,
    'superate_older_dependant_any': 117.78048780487805,
    'superate_older_severe_dependant_any': 63.09756097560975,
    'superate_care_receiver_any': 1774.6341463414635,
    'superate_care_receiver_wo_mild_dependant_any': 1735.7317073170732,
    'superate_care_receiver_wo_5to12_any': 1290.7317073170732,
    'superate_care_receiver_wo_both_any': 1248.0975609756097,
    'domestic_worker_any': 272.8536585365854,
    'woman_houseworker_sum': 873.4878048780488,
    'woman_poor_sum': 2172.2926829268295,
    'is_female_sum': 5879.292682926829,
    'monomarental_with_superate_child': 303.9512195121951,
    'monomarental_with_superate_disability': 140.1219512195122,
    'monomarental_with_superate_elder_dependant': 26.0,
    'is_poor': 1289.121951219512,
    'household_id': 3568.682926829268,
    'dependence_0to4_rate': 0.5666847746572299,
    'dependence_5to12_rate': 0.668869624504941,
    'dependence_dissability_13to64_rate': 0.7135365105025621,
    'dependence_dissability_5to64_rate': 0.7076247141355235,
    'dependence_older_dependant_rate': 0.6729007210585812,
    'dependence_older_severe_dependant_rate': 0.6545712960113739,
    'dependence_rate_micro_wo_both': 0.6422557594435134,
    'dependence_rate_micro_wo_5to12': 0.6478332893186635,
    'dependence_rate_micro_wo_mild_dependant': 0.7208281681058327,
    'dependence_rate_micro': 0.7254463585179948,
    'capacidad total (CAIPI)': 3.596462483774342,
    '# COS INFOTEP': 0.0203563087691394,
    'capacidad total (ASFL DIURNAS)': 0.4780323058487131,
    'capacidad total (ESTANCIAS CONAPE)': 0.06704240772795779,
    '# CCPP SIN EPES': 0.002937550579967832,
    '# Oficina de la Mujer': 0.0035062187092327886,
    '# Direccion Regional PROSOLI': 0.0010317503635039638,
    'capacidad total (CTC CON EPES)': 0.23390604496529063,
    'capacidad total (CCPP CON EPES)': 0.12979270683901878,
    'capacidad total (Nuevos C. de Dia CONAPE)': 0.020909054024859753,
    '# Direccion Regional INFOTEP': 0.0007148744448885279,
    'capacidad total (ASFL PERMANENTES)': 0.1111419492496138,
    '# CAID': 0.00023822030301658899,
    'capacidad total (TOTAL CONAPE)': 0.6771257168511444,
    'accesible_child_0to4_receiver_caipi': 1.6929566255471549,
    'accesible_child_0to4_receiver_ccpp_epes': 0.6199761241543972,
    'accesible_elder_asfl_diurna': 0.22530839633903701,
    'accesible_elder_asfl_permanente': 0.14174293672900914,
    'accesible_elder_estancias_conape': 0.14285714285714285,
    'accesible_elder_nuevos_conape': 0.09383207321925985,
    'accesible_severe_asfl_diurna': 0.1203342618384401,
    'accesible_severe_asfl_permanente': 0.07369677676084362,
    'accesible_severe_estancias_conape': 0.07489056904098687,
    'accesible_severe_nuevos_conape': 0.04990051730998806,
    'coverage_caipi': 0.011602974174606404,
    'coverage_ccpp_epes': 5.834660694729507e-05,
    'coverage_ccpp_sin_epes': 3.5353595865517414e-06,
    'coverage_ctc_epes': 0.0,
    'coverage_prosoli': 2.2393199382172813e-07,
    'coverage_asfl_dia': 0.0029047755382319443,
    'coverage_asfl_permanente': 0.00019447400235614098,
    'coverage_conape_estancia': 0.0008868934586270859,
    'coverage_conape_dia': 5.870235272822568e-05,
    'coverage_total_conape': 0.0034761691900138023,
    'coverage_caid': 0.0,
    'coverage_mujer': 1.1780479616396907e-06,
    'coverage_cos_infotep': 6.259558178586706e-06,
    'coverage_infotep': 0.0,
    'installed_cap_index': 0.0003842497598621663,
    'rank_installed_cap_index': 6283.0,
    'offer_index': 0.004341210106147798,
    'rank_offer_index': 6283.0,
    'percentage_households_child_0to4': 0.22848192277410415,
    'percentage_households_child_5to12': 0.24846748388032952,
    'percentage_households_disability_5to64': 0.14726683756994027,
    'percentage_households_disability_13to64': 0.14051523043326125,
    'percentage_households_older_dependant': 0.032087294607326115,
    'percentage_households_older_severe_dependant': 0.016077399918588215,
    'percentage_households_care_receiver': 0.5274458460647342,
    'percentage_households_care_receiver_wo_mild_dependant': 0.5149253385807946,
    'percentage_households_care_receiver_wo_5to12': 0.3839090454106672,
    'percentage_households_care_receiver_wo_both': 0.3704730154190188,
    'percentage_households_domestic_worker': 0.08454461275809336,
    'percentage_households_monomarental_child': 0.07745850235485842,
    'percentage_households_monomarental_disability': 0.05880055534249588,
    'percentage_households_monomarental_elder_dependant': 0.005772478995666244,
    'percentage_households_poor': 0.38289213833080354,
    'percentage_woman_domestic_worker': 0.07028247521972827,
    'percentage_woman_houseworker': 0.22678872353950752,
    'percentage_men_domestic_worker': 0.0035745718355572535,
    'percentage_poor_women': 0.3862854453799478,
    'perc_accesible_child_0to4_receiver_caipi': 0.5197331841223817,
    'perc_accesible_child_0to4_receiver_ccpp_epes': 0.18433618018216663,
    'perc_accesible_elder_asfl_diurna': 0.5337616125777632,
    'perc_accesible_elder_asfl_permanente': 0.29981223628519915,
    'perc_accesible_elder_estancias_conape': 0.30679261600121344,
    'perc_accesible_elder_nuevos_conape': 0.19020343473156204,
    'perc_accesible_severe_asfl_diurna': 0.5484892378862658,
    'perc_accesible_severe_asfl_permanente': 0.28998479019493023,
    'perc_accesible_severe_estancias_conape': 0.2996119908268638,
    'perc_accesible_severe_nuevos_conape': 0.19055877822703782,
    'agg_dependence_rate_child_0to4': 0.13701938583960455,
    'agg_dependence_rate_child_5to12': 0.171749994883598,
    'agg_dependence_rate_disability_5to64': 0.11768472945045058,
    'agg_dependence_rate_disability_13to64': 0.1134056417498035,
    'agg_dependence_rate_older_dependant': 0.024766416608098415,
    'agg_dependence_rate_older_severe_dependant': 0.011701286999284315,
    'agg_dependence_rate_care_receiver': 0.38713215536971735,
    'agg_dependence_rate_care_receiver_wo_mild_dependant': 0.3763434648224196,
    'agg_dependence_rate_care_receiver_wo_5to12': 0.2524625109411576,
    'agg_dependence_rate_care_receiver_wo_both': 0.2421284739066726,
    'demanda_de_ciudado': 0.19391841049223063,
    'presencia_de_ciudadoras': 0.2841228559568045,
    'pobreza': 0.3095209686502382,
    'indice_priorizacion_ciudados': 0.33677673614422604,
    'superate_coverage': 0.024390243902439022}
    
    for k in internal_dict.keys():
        if k in external_dict.keys():
            if external_dict[k] ==0:
                diff = internal_dict[k]
            else:
                diff = np.abs((internal_dict[k]-external_dict[k])/ external_dict[k])
            assert diff< .00001


def test_shape_end_rodrigo_municipality_integration():
    assert stats_processed_municipality.shape ==(155, 136)
    
def test_describe_end_rodrigo_municipality_integration():
    df_describe =  stats_processed_municipality.describe()
    internal_dict = df_describe.loc['mean'].to_dict() 
    external_dict ={'caipi_sum': 3.2777777777777777,
    'member_0to4_sum': 46027.0,
    'recibe_ciudados_inaipi_sum': 545.0,
    'recibe_ciudados_publico_no_inaipi_sum': 701.0,
    'recibe_ciudados_privado_sum': 393.0,
    'recibe_ciudados_otros_sum': 4582.0,
    'superate_child_0to4_receiver_sum': 39138.0,
    'member_5to12_sum': 72474.0,
    'superate_child_5to12_receiver_sum': 48539.0,
    'superate_disability_13to64_sum': 22026.0,
    'superate_disability_5to64_sum': 23587.0,
    'superate_older_dependant_sum': 5098.0,
    'superate_older_severe_dependant_sum': 2693.0,
    'woman_domestic_worker_sum': 11090.0,
    'woman_work_age_sum': 174461.0,
    'man_domestic_worker_sum': 403.0,
    'man_work_age_sum': 152861.0,
    'member_id_count': 463262.0,
    'superate_child_0to4_receiver_any': 32796.0,
    'superate_child_5to12_receiver_any': 36176.0,
    'superate_disability_13to64_any': 18547.0,
    'superate_disability_5to64_any': 19593.0,
    'superate_older_dependant_any': 4829.0,
    'superate_older_severe_dependant_any': 2587.0,
    'superate_care_receiver_any': 72760.0,
    'superate_care_receiver_wo_mild_dependant_any': 71165.0,
    'superate_care_receiver_wo_5to12_any': 52920.0,
    'superate_care_receiver_wo_both_any': 51172.0,
    'domestic_worker_any': 11187.0,
    'woman_houseworker_sum': 35813.0,
    'woman_poor_sum': 89064.0,
    'is_female_sum': 241051.0,
    'monomarental_with_superate_child': 12462.0,
    'monomarental_with_superate_disability': 5745.0,
    'monomarental_with_superate_elder_dependant': 1066.0,
    'is_poor': 52854.0,
    'household_id': 146316.0,
    'dependence_0to4_rate': 0.5565717560255251,
    'dependence_5to12_rate': 0.5989643625365805,
    'dependence_dissability_13to64_rate': 0.7185844502359507,
    'dependence_dissability_5to64_rate': 0.7117855306967275,
    'dependence_older_dependant_rate': 0.6742866261731646,
    'dependence_older_severe_dependant_rate': 0.6413027439546235,
    'dependence_rate_micro_wo_both': 0.6259612155942522,
    'dependence_rate_micro_wo_5to12': 0.6313256048229613,
    'dependence_rate_micro_wo_mild_dependant': 0.6922281653524548,
    'dependence_rate_micro': 0.6962034405272955,
    'capacidad total (CAIPI)': 291.57141307359996,
    '# COS INFOTEP': 1.6504178964362028,
    'capacidad total (ASFL DIURNAS)': 38.760648114457794,
    'capacidad total (ESTANCIAS CONAPE)': 5.4356007000478685,
    '# CCPP SIN EPES': 0.23815312198221056,
    '# Oficina de la Mujer': 0.2842492271757971,
    '# Direccion Regional PROSOLI': 0.08364527545629405,
    'capacidad total (CTC CON EPES)': 18.961812685268388,
    'capacidad total (CCPP CON EPES)': 10.523831124637699,
    'capacidad total (Nuevos C. de Dia CONAPE)': 1.6948743700390805,
    '# Direccion Regional INFOTEP': 0.05794532402486431,
    'capacidad total (ASFL PERMANENTES)': 9.010331708617763,
    '# CAID': 0.019312265678253077,
    'capacidad total (TOTAL CONAPE)': 54.90145489316252,
    'accesible_child_0to4_receiver_caipi': 137.23870967741937,
    'accesible_child_0to4_receiver_ccpp_epes': 50.25806451612903,
    'accesible_elder_asfl_diurna': 18.26451612903226,
    'accesible_elder_asfl_permanente': 11.490322580645161,
    'accesible_elder_estancias_conape': 11.580645161290322,
    'accesible_elder_nuevos_conape': 7.606451612903226,
    'accesible_severe_asfl_diurna': 9.754838709677419,
    'accesible_severe_asfl_permanente': 5.974193548387097,
    'accesible_severe_estancias_conape': 6.070967741935484,
    'accesible_severe_nuevos_conape': 4.04516129032258,
    'coverage_caipi': 0.0004971620239724504,
    'coverage_ccpp_epes': 2.796967775268732e-05,
    'coverage_ccpp_sin_epes': 2.9874135785863437e-07,
    'coverage_ctc_epes': 0.0,
    'coverage_prosoli': 6.347684543332105e-08,
    'coverage_asfl_dia': 0.0013720083886769104,
    'coverage_asfl_permanente': 9.492268620836884e-05,
    'coverage_conape_estancia': 0.0001404023193821293,
    'coverage_conape_dia': 2.406544410029494e-05,
    'coverage_total_conape': 0.0016313988383677037,
    'coverage_caid': 0.0,
    'coverage_mujer': 2.471670633400962e-08,
    'coverage_cos_infotep': 4.50240681842447e-07,
    'coverage_infotep': 0.0,
    'installed_cap_index': 0.005241935483870968,
    'rank_installed_cap_index': 78.0,
    'offer_index': 0.05379971019466172,
    'rank_offer_index': 78.0,
    'percentage_households_child_0to4': 0.22414500123021405,
    'percentage_households_child_5to12': 0.2472456874162771,
    'percentage_households_disability_5to64': 0.13390880013122283,
    'percentage_households_disability_13to64': 0.12675988955411574,
    'percentage_households_older_dependant': 0.033003909346893026,
    'percentage_households_older_severe_dependant': 0.01768090981164056,
    'percentage_households_care_receiver': 0.4972798600289784,
    'percentage_households_care_receiver_wo_mild_dependant': 0.4863787965772711,
    'percentage_households_care_receiver_wo_5to12': 0.3616829328303125,
    'percentage_households_care_receiver_wo_both': 0.34973618742994617,
    'percentage_households_domestic_worker': 0.07645780365783646,
    'percentage_households_monomarental_child': 0.08517181989666202,
    'percentage_households_monomarental_disability': 0.039264331993766916,
    'percentage_households_monomarental_elder_dependant': 0.00728560102791219,
    'percentage_households_poor': 0.36123185434265564,
    'percentage_woman_domestic_worker': 0.06356721559546259,
    'percentage_woman_houseworker': 0.205277970434653,
    'percentage_men_domestic_worker': 0.0026363820726019063,
    'percentage_poor_women': 0.3694819768430747,
    'perc_accesible_child_0to4_receiver_caipi': 0.5435126986560376,
    'perc_accesible_child_0to4_receiver_ccpp_epes': 0.19903929684705401,
    'perc_accesible_elder_asfl_diurna': 0.5553158101216163,
    'perc_accesible_elder_asfl_permanente': 0.34935268732836405,
    'perc_accesible_elder_estancias_conape': 0.3520988622989408,
    'perc_accesible_elder_nuevos_conape': 0.2312671635935661,
    'perc_accesible_severe_asfl_diurna': 0.5614556256962495,
    'perc_accesible_severe_asfl_permanente': 0.343854437430375,
    'perc_accesible_severe_estancias_conape': 0.3494244337170442,
    'perc_accesible_severe_nuevos_conape': 0.23282584478277016,
    'agg_dependence_rate_child_0to4': 0.12475277693904373,
    'agg_dependence_rate_child_5to12': 0.14809135555320904,
    'agg_dependence_rate_disability_5to64': 0.09531434636636445,
    'agg_dependence_rate_disability_13to64': 0.0910876855472141,
    'agg_dependence_rate_older_dependant': 0.02225409468404147,
    'agg_dependence_rate_older_severe_dependant': 0.011338815977819315,
    'agg_dependence_rate_care_receiver': 0.3462079494571067,
    'agg_dependence_rate_care_receiver_wo_mild_dependant': 0.3366851020210192,
    'agg_dependence_rate_care_receiver_wo_5to12': 0.22833969632323953,
    'agg_dependence_rate_care_receiver_wo_both': 0.21892128902094835,
    'demanda_de_ciudado': 0.0,
    'presencia_de_ciudadoras': 0.0,
    'pobreza': 0.0,
    'indice_priorizacion_ciudados': 0.0}
    
    for k in internal_dict.keys():
        if k in external_dict.keys():
            if external_dict[k] ==0:
                diff = internal_dict[k]
            else:
                diff = np.abs((internal_dict[k]-external_dict[k])/ external_dict[k])
            assert diff< .00001